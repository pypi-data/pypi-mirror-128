var nt=Object.defineProperty;var at=(w,t,s)=>t in w?nt(w,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):w[t]=s;var I=(w,t,s)=>(at(w,typeof t!="symbol"?t+"":t,s),s);import{_ as Te,A as it,E as ot}from"./index.f94ea891.js";import{e as Ee,f as z,s as E,i as rt,ak as je,j as we,C as ct,al as lt,r as Se,o as ne,c as ye,d as F,F as Fe,l as dt,m as Be,u as D,n as ut,a7 as Re,G as pt,k as gt,ae as ht,a as ue,p as vt,b as mt,am as Ge,_ as U,an as ze,ao as Oe,M as _t}from"./vendor.69dad681.js";const be=Math.cos,We=Math.max,xe=Math.sin,$e=Math.sqrt,Ae=Math.pow,Ve=Math.floor,ft=Math.ceil,f=Math.PI,ae=w=>Ae(w,2);function De(w){return Array.from(w).filter(([,t])=>t.nodes.size==0)}function wt(w){var s;return(s=De(w)[0])==null?void 0:s[0]}class yt{constructor(){I(this,"_id","id");I(this,"_dependencies","upstream_ids");I(this,"nodes",new Map);I(this,"positions",new Map);I(this,"links",[]);I(this,"rings",new Map);I(this,"expandedRings",[]);I(this,"baseRadius",500);I(this,"channelWidth",250);I(this,"width",275);I(this,"height",145);I(this,"cx",0);I(this,"cy",0);return this}center([t,s]){return this.cx=t,this.cy=s,this}expandRing(t){if(!this.rings.get(t))throw new Error("Invalid ringId when expanding ring.");if(this.expandedRings.includes(t))throw new Error("Attempted to expand an already expanded ring.");return this.expandedRings.push(t),this.computeRings(),this.computeInitialPositions(),this}collapseRing(t){if(!this.rings.get(t))throw new Error("Invalid ringId when collapsing ring.");const n=this.expandedRings.indexOf(t);if(n==-1)throw new Error("Attempted to collapse an already collapsed ring.");return this.expandedRings.splice(n,1),this.computeRings(),this.computeInitialPositions(),this}id(t){return this._id=t,this}dependencies(t){return this._dependencies=t,this}items(t){return this.update(t),this}traverse(t,s){if(!t)throw new Error("No starting node was provided to the traverse method.");const n=[t];let i;const l=new Map;for(;n.length>0;)if(i=n.shift(),s==null||s(i),!!i.downstreamNodes.size)for(const[o,u]of i.downstreamNodes)n.push(u),l.set(o,i);return l}update(t){this.nodes=new Map,this.rings=new Map,this.links=[],this.computeNodes(t),this.computeLinks(),this.computeNodeRings(),this.computeRings(),this.computeInitialPositions()}computeNodes(t){const s=t.length;for(let n=0;n<s;n++){const i=t[n],l=this.nodes.get(i[this._id]);l?this.nodes.set(i[this._id],{id:i[this._id],cx:l.cx,cy:l.cy,radian:l.radian,data:i,downstreamNodes:new Map,upstreamNodes:new Map,ring:l.ring}):this.nodes.set(i[this._id],{id:i[this._id],cx:0,cy:0,radian:0,data:i,downstreamNodes:new Map,upstreamNodes:new Map,ring:0})}}computeNodeRings(){const t=[...this.rings.entries()];for(const[s,n]of this.nodes){const i=this.distance(n,"up");n.ring=i,this.nodes.set(s,n),t[i]?t[i][1].nodes.set(s,n):t[i]=[i,{radius:0,nodes:new Map([[s,n]]),positions:new Map,links:[]}]}this.rings=new Map(t)}computeLinks(){for(const[t,s]of this.nodes){const n=s.data[this._dependencies],i=n.length;for(let l=0;l<i;l++){const o=this.nodes.get(n[l][this._id]),u={target:s,source:o};s.upstreamNodes.set(n[l][this._id],o),o.downstreamNodes.set(t,s),this.nodes.set(n[l][this._id],o),this.nodes.set(t,s),this.links.push(u)}}}distance(t,s){const n=s=="up"?"upstreamNodes":s=="down"?"downstreamNodes":void 0;if(n==null)throw new Error("Direction wasn't provided; accepted values: 'up' or 'down'.");const i=(l,o=0)=>{if(l[n].size>0){const u=[];o=o+1;for(const[,k]of l[n]){const b=i(k,o);u.push(b)}return We(...u)}return o};return i(t)}computeRings(t=0){var n;const s=[...this.rings.entries()];for(let i=t;i<s.length;i++){const l=s[0][1].nodes.size,o=s[i][1].nodes.size,u=(n=s[i-1])==null?void 0:n[1];let k;if(u?k=u.radius+this.baseRadius:k=l===1?i*this.baseRadius:(i+1)*this.baseRadius,this.expandedRings.includes(i)&&o>1){const P=$e(ae(this.height)+ae(this.width));k=We(ft(o*P/(f*2)),k)}const b=this.computeRingPositions(k);s[i][1].radius=k,s[i][1].positions=b;for(let P=0;P<b.size;P++){const y=b.get(P);!y||this.positions.set(y.id,y)}}this.rings=new Map(s),this.links.forEach(i=>{const l=this.rings.get(i.source.ring);l&&(l.links.push(i),this.rings.set(i.source.ring,l))})}computeInitialPositions(){if(this.rings.size===0)return;let t;for(const[s,n]of this.rings){let i=0;for(const[l,o]of n.nodes){const u=this.getNodePosition(o,s,t,i);o.cx=this.cx+n.radius*be(u.radian),o.cy=this.cy+n.radius*xe(u.radian),o.radian=u.radian,o.position=u,u.nodes.set(o.id,o),n.positions.set(u.id,u),this.rings.set(s,n),this.nodes.set(l,o),++i}t=n}this.nodes=new Map([...this.nodes].sort(([,s],[,n])=>!s.position||!n.position?0:s.ring==n.ring?s.position.id-n.position.id:s.ring-n.ring))}computeRingPositions(t){const s=new Map;if(t<=0)return s.set(0,{id:0,radian:0,nodes:new Map,radius:t}),s;let n=0,i=0;const l=[0],o=f/2-this.width*.8/2/t;for(;n<o;){const u=1.25-.3*xe(n),k=$e(ae(this.height)*ae(be(i))+ae(this.width)*ae(xe(i))),b=u*k/t;i+=b,n+=b,n<o&&(n<t/(this.channelWidth+this.width/2)&&(l.push(n%(2*f)),l.push((3*f-n)%(2*f))),l.push((f+n)%(2*f)),l.push((2*f-n)%(2*f)))}return l.push(f),l.sort().forEach((u,k)=>s.set(k,{id:k,radian:u,nodes:new Map,radius:t})),s}getNodePosition(t,s,n,i=0){var b,P;const o=this.rings.get(s).positions;let u;if([...o.values()].every(y=>y.nodes.size>0))return o.get(o.size-1);if(t.upstreamNodes.size===0||s==0||s==1){const y=De(o);i===0||i%2==0?u=o.get((b=y[0])==null?void 0:b[0]):u=o.get((P=y[Ve(y.length/2)])==null?void 0:P[0])}else{const y=t.upstreamNodes.entries();for(;!u;){const[,ee]=y.next().value||[null,null];if(!ee)break;const Y=Ve(ee.position/n.positions.size*o.size),B=o.get(Y);if(B&&B.nodes.size===0){u=B;break}let R=Y-1==0?o.size-1:Y-1,ie=Y+1;for(;R>=0||ie<=o.size;){const K=o.get(R);if(K&&K.nodes.size===0){u=K;break}const oe=o.get(ie);if(oe&&oe.nodes.size===0){u=oe;break}R--,ie++}}}if(!u){const y=wt(o);u=typeof y!="undefined"?o.get(y):o.get(o.size-1)}return u}}const Ye=w=>(vt("data-v-b9162064"),w=w(),mt(),w),xt=Ye(()=>F("svg",{class:"radar__canvas"},[F("g",{class:"radar__edge-container"}),F("g",{class:"radar__ring-container"})],-1)),kt={class:"radar__node-container"},Mt={class:"radar__minimap-container position-absolute mr-2 mb-2"},Rt={class:"mb-1 d-flex align-center justify-end"},zt=Ye(()=>F("g",{class:"radar__minimap-ring-container"},null,-1)),bt=[zt],$t=Ee({props:{items:{type:Array,required:!0},id:{type:String,required:!0}},setup(w){const t=w,s=z(t.items),n=z(),i=z(),l=z(),o=z(),u=z(),k=z(),b=z(),P=z(),y=E(()=>{const a=[...te.value.entries()];return new Map([...A.value.nodes.entries()].filter(([,r])=>a.every(([,m])=>!m.get(r.id))).filter(([,r])=>{var d;if(!A.value.rings.get(r.ring))return;const _=r.position;if(!_)return;const h=[..._.nodes.values()];return((d=h==null?void 0:h[0])==null?void 0:d.id)==r.id}))}),ee=E(()=>{const a=new Set([...y.value.entries()].map(([,r])=>r.ring));return new Map([...A.value.rings.entries()].filter(([r])=>a.has(r)))}),Y=E(()=>{const a=[...te.value.entries()];return A.value.links.filter(r=>a.every(([,m])=>!m.get(r.target.id))).filter(r=>y.value.get(r.source.id)&&y.value.get(r.target.id))}),B=E(()=>{const a=[...ee.value.entries()].map(([,r])=>r.radius);return Math.max(...a,qe*2)});E(()=>{const a=O.value+B.value,r=G.value+B.value;return[[-B.value,-B.value],[a,r]]});const R=E(()=>200/(B.value*2.5)),ie=E(()=>({height:K.value.height+"px",width:K.value.width+"px"})),K=E(()=>({height:G.value*R.value,width:O.value*R.value})),oe=({transform:a})=>{var m,_,h;const r=`translate(${a.x}px, ${a.y}px) scale(${a.k})`;if((m=k.value)==null||m.style("transform",r),(_=u.value)==null||_.style("transform",r),(h=P.value)==null||h.style("transform",r),Le=a.k,i.value){const d=(1-a.x/a.k)*R.value+100-K.value.width/2,j=(1-a.y/a.k)*R.value+100-K.value.height/2;i.value.style.transform=`translate(${d}px, ${j}px) scale(${1/a.k})`,i.value.style.borderRadius=`${Math.max(4*a.k,4)}px`}},Ke=a=>{A.value.expandRing(a.ring)},Xe=a=>{if(te.value.get(a.id))te.value.delete(a.id);else{const r=A.value.traverse(a);te.value.set(a.id,r)}},He=()=>{var d,j;const a=(c,e,p,g)=>{const x=g*(f/180),M=c+p*be(x)||0,T=e+p*xe(x)||0;return[M,T]},r=([,c],e=1)=>{const p=c.radius,x=125*360/(2*f*p),M=O.value/2*e,T=G.value/2*e,[v,N]=a(M,T,p,90-x),[q,Q]=a(M,T,p,90+x);return`M ${v} ${N} A${c.radius} ${c.radius} 0 1 0 ${q} ${Q}`},m=(c,e=1)=>{const p=c.radius,g=100,x=100,M=Oe();return M.arc(g,x,p,c.start,c.end,!1),M.toString()},_=([,c])=>{var N,q,Q,re,he;const e=[],p=c.radius,x=125*360/(2*f*p||10),M=(90-x)*f/180,T=(90+x)*f/180;let v=((N=c.positions.get(c.positions.size-1))==null?void 0:N.radian)||0;for(const[S,C]of c.positions){const Z=[...C.nodes.values()],ce=(he=(re=(Q=(q=Z==null?void 0:Z[0])==null?void 0:q.data)==null?void 0:Q.state)==null?void 0:re.type)==null?void 0:he.toLowerCase();p==0?e.push({start:115*f/180,end:65*f/180,radius:qe/4,state:ce||null}):C.radian>M&&v<T?(e.push({start:v,end:M,radius:p,state:null}),e.push({start:T,end:C.radian,radius:p,state:ce||null})):e.push({start:v,end:C.radian,radius:p,state:ce||null}),v=C.radian}return e};(d=k.value)==null||d.selectAll(".radar__ring").data(ee.value).join(c=>{const e=c.append("g");return e.attr("id",g=>g.id),e.attr("class","radar__ring").append("path").attr("id",([g])=>g).attr("d",g=>r(g,1)).style("opacity",1).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.03)").attr("stroke-width",80),e},c=>(c.select("path").attr("id",([p])=>p).attr("d",p=>r(p,1)),c),c=>c.remove());const h=c=>`radar__arc-segment ${c.state?`${c.state}-stroke`:""}`;(j=b.value)==null||j.style("transform",`scale(${R.value})`).selectAll(".radar__arc-segment-group").data(ee.value).join(c=>c.append("g").attr("class","radar__arc-segment-group"),c=>c,c=>c.remove()).selectAll(".radar__arc-segment").data(c=>_(c)).join(c=>c.append("path").attr("class",h).attr("fill","transparent").attr("stroke","rgba(0, 0, 0, 0.1)").attr("stroke-width",80).attr("d",e=>m(e,R.value)),c=>c.attr("class",h).attr("d",e=>m(e,R.value)),c=>c.remove())},pe=()=>{var c;const a=(e,p,g,x,M)=>{const T=$e(Ae(g-e,2)+Ae(x-p,2)),v=M/T,N=(1-v)*e+v*g,q=(1-v)*p+v*x;return[N,q]},r=(e,p)=>{const g=Oe(),x=f/2,M=3*f/2,T=0,v=A.value.rings.get(e.source.ring),N=A.value.rings.get(e.target.ring),q=A.value.rings.get(e.target.ring-1),Q=A.value.rings.get(e.source.ring+1),re=v.links,he=re.findIndex(L=>L.source.id==e.source.id&&L.target.id==e.target.id),S=O.value/2,C=G.value/2,Z=(N.radius-v.radius)/2,ce=Z/re.length,Pe=he*ce,ve=e.target.cx,me=e.target.cy,X=e.target.radian,_e=e.source.cx,fe=e.source.cy,H=e.source.radian;let le,de;if(v.radius==0){const[L,V]=a(S,C,ve,me,N.radius-v.radius);le=L,de=V}else if(e.target.ring-e.source.ring==1){const[L,V]=a(S,C,_e,fe,v.radius+Z*1.25-Pe);le=L,de=V}else{const[L,V]=a(S,C,_e,fe,v.radius+(Q.radius-v.radius)/2);le=L,de=V}if(g.moveTo(_e,fe),e.target.ring-e.source.ring>1){v.radius!==0&&(g.lineTo(le,de),g.arc(S,C,v.radius+(Q.radius-v.radius)/2,H,x,H<M&&H>T));const L=q.radius+(N.radius-q.radius)/2,[V,se]=a(S,C,S,L,q.radius+(N.radius-q.radius)/2);g.lineTo(V,se),g.arc(S,C,q.radius+(N.radius-q.radius)/2,x,X,X>M||X<x)}else{g.lineTo(le,de);const[L,V]=a(S,C,ve,me,N.radius-v.radius);if(ve!==_e&&me!==fe&&v.radius!==0){const se=f/2;g.arc(S,C,v.radius+Z*1.25-Pe,H,X,H>se&&X>se&&X<H||H<se&&(X>se||X<H))}else g.moveTo(L,V)}return g.lineTo(ve,me),g.toString()},m=e=>{const p=A.value.rings.get(e.source.ring),g=A.value.rings.get(e.target.ring),x=p.links,M=(g.radius-p.radius)/x.length;return Math.min(5,M)},_=e=>{const p=$.includes(e.source.id)||$.includes(e.target.id),g=W.value&&(e.source.id==W.value||e.target.id==W.value);return p||g},h=e=>!W.value&&$.length===0||_(e)?1:.2,d=e=>e.source.id+"---"+e.target.id,j=e=>{const p=["radar__edge"];return(_(e)||$.length==0&&!W.value)&&p.push(`${e.source.data.state.type.toLowerCase()}-stroke`),Y.value.length<100&&p.push("radar__edge--transition"),p.join(" ")};(c=u.value)==null||c.selectAll(".radar__edge").data(Y.value).join(e=>e.append("path").attr("id",d).attr("class",j).style("stroke-width",m).attr("d",r).style("opacity",h),e=>e.attr("id",d).attr("class",j).style("stroke-width",m).attr("d",r).style("opacity",h),e=>e.remove())},ke=()=>{He(),pe()},Ce=a=>{W.value==a?W.value=void 0:W.value=a,requestAnimationFrame(()=>pe())},Ie=a=>{const r=$.indexOf(a);r>-1?$.splice(r,1):$.push(a)},Ue=a=>{var d;const r=(d=a.target)==null?void 0:d.getBoundingClientRect(),m=(a.clientX-r.left-100)/R.value,_=(a.clientY-r.top-100)/R.value,h=Ge.scale(Le).translate(-m,-_);requestAnimationFrame(()=>{U(".radar__canvas").transition().duration(200).call(J.value.transform,h)})},Je=a=>{if(!ge.value)return;const r=a.movementX*-(1/R.value),m=a.movementY*-(1/R.value);J.value.translateBy(U(".radar__canvas"),r,m)},Qe=()=>{$.length=0},Ne=()=>{U(".radar__canvas").transition().ease(ze).duration(250).call(J.value.transform,Ge)},Ze=()=>{requestAnimationFrame(()=>{J.value.scaleBy(U(".radar__canvas").transition().ease(ze).duration(250),1.35)})},et=()=>{requestAnimationFrame(()=>{J.value.scaleBy(U(".radar__canvas").transition().ease(ze).duration(250),.65)})},G=z(0),O=z(0),qe=300,W=z(),$=rt([]),ge=z(!1);let Le=1;const te=z(new Map),A=z(new yt),J=z(je());we(()=>[t.items,t.id],(a,r)=>{const[m,_]=a,[h,d]=r;s.value=t.items,A.value.items(s.value),(m.length>0&&h.length==0||_!==d)&&(A.value.center([O.value/2,G.value/2]),$.length=0,Ne()),m.length!==h.length||_!==d?requestAnimationFrame(()=>ke()):requestAnimationFrame(()=>pe())}),we($,()=>{requestAnimationFrame(()=>pe())}),we(Y,()=>{requestAnimationFrame(()=>ke())});const Me=()=>{!n.value||(G.value=n.value.offsetHeight,O.value=n.value.offsetWidth)},tt=()=>{var a,r;o.value=U(".radar__canvas"),l.value=U(".radar__minimap-canvas"),k.value=o.value.select(".radar__ring-container"),b.value=l.value.select(".radar__minimap-ring-container"),u.value=o.value.select(".radar__edge-container"),P.value=U(".radar__node-container"),b.value.style("transform",`scale(${R.value})`),J.value=je().extent([[0,0],[O.value,G.value]]).on("zoom",oe),(a=l.value)==null||a.attr("viewbox","0, 0, 200, 200"),(r=o.value)==null||r.attr("viewbox",`0, 0, ${O.value}, ${G.value}`).call(J.value),ke()},st=a=>{a.preventDefault(),!!n.value&&(n.value.scrollTop=0,n.value.scrollLeft=0)};return ct(()=>{Me(),window.addEventListener("resize",Me),A.value.id("id").dependencies("upstream_dependencies").center([O.value/2,G.value/2]).items(s.value),tt()}),lt(()=>{window.removeEventListener("resize",Me)}),(a,r)=>{const m=Se("radar-overflow-node"),_=Se("icon-button");return ne(),ye("div",{ref:(h,d)=>{d.container=h,n.value=h},class:"radar",onScroll:st},[xt,F("div",kt,[(ne(!0),ye(Fe,null,dt(D(y),([h,d])=>{var j,c;return ne(),ye(Fe,{key:h},[((j=d.position)==null?void 0:j.nodes.size)==1?(ne(),Be(ht(d.data.state.state_details.child_flow_run_id?"radar-flow-run-node":"radar-node"),{key:0,node:d,selected:D($).includes(d.id),class:ut(["radar__node position-absolute",{"radar__node--transparent":D($).length>0&&!D($).includes(d.id)&&W.value!==d.id,"radar__node--deemphasized":D($).length>0&&D($).some(e=>d.upstreamNodes.get(e)||d.downstreamNodes.get(e))}]),collapsed:te.value.get(h),style:Re({left:d.cx+"px",top:d.cy+"px"}),tabindex:"0",onToggleTree:Xe,onClick:pt(e=>Ie(d.id),["stop"]),onKeyup:gt(e=>Ie(d.id),["space","enter"]),onMouseover:e=>Ce(d.id),onMouseout:e=>Ce(d.id)},null,8,["node","selected","class","collapsed","style","onClick","onKeyup","onMouseover","onMouseout"])):(ne(),Be(m,{key:1,class:"position-absolute",nodes:(c=d.position)==null?void 0:c.nodes,style:Re({left:d.cx+"px",top:d.cy+"px"}),tabindex:"0",onClick:e=>Ke(d)},null,8,["nodes","style","onClick"]))],64)}),128))]),F("div",Mt,[F("div",Rt,[ue(_,{class:"bg--white justify-self-start mr-auto",icon:"pi-restart-line",onClick:Qe}),ue(_,{class:"bg--white mr-1",icon:"pi-zoom-in-line",onClick:Ze}),ue(_,{class:"bg--white mr-1",icon:"pi-zoom-out-line",onClick:et}),ue(_,{class:"bg--white",icon:"pi-fullscreen-fill",onClick:Ne})]),F("div",{class:"radar__minimap position-relative",onMousemove:Je,onMouseleave:r[2]||(r[2]=h=>ge.value=!1)},[F("svg",{class:"radar__minimap-canvas",onClick:Ue},bt),F("div",{ref:(h,d)=>{d.viewport=h,i.value=h},class:"radar__minimap-viewport position-absolute",style:Re(D(ie)),onMousedown:r[0]||(r[0]=h=>ge.value=!0),onMouseup:r[1]||(r[1]=h=>ge.value=!1)},null,36)],32)])],544)}}});var At=Te($t,[["__scopeId","data-v-b9162064"]]);const Ct={class:"radar z-0"},It=Ee({setup(w){const t=_t(),s=E(()=>t==null?void 0:t.params.id),n=E(()=>({id:s.value})),i={radar:it.query({endpoint:ot.radar,body:n,options:{pollInterval:5e3}})},l=E(()=>{var o;return((o=i.radar.response)==null?void 0:o.value)||[]});return we(s,()=>{!s.value||i.radar.fetch()}),(o,u)=>(ne(),ye("div",Ct,[ue(At,{id:D(s),items:D(l)},null,8,["id","items"])]))}});var Pt=Te(It,[["__scopeId","data-v-18cdbfba"]]);export{Pt as default};
