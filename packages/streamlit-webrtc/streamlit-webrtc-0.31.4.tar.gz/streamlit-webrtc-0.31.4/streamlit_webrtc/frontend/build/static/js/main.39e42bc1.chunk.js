(this.webpackJsonpstreamlit_webrtc=this.webpackJsonpstreamlit_webrtc||[]).push([[0],{110:function(e,t,n){"use strict";n.r(t);var r=n(0),i=n.n(r),a=n(16),o=n.n(a),c=n(42),d=n(74),s=n(148),l=n(70),u=n.n(l),f=n(7),v=function(e){var t=Object(c.useRenderData)().theme,n=JSON.stringify(t),r=i.a.useMemo((function(){var e=JSON.parse(n);if(null!=e){var t=u.a.scale([e.textColor,e.backgroundColor]).mode("lab");return Object(d.a)({palette:{primary:{main:e.primaryColor},background:{default:e.backgroundColor,paper:e.secondaryBackgroundColor},text:{primary:e.textColor,secondary:t(.1).hex(),disabled:t(.5).hex()}},typography:{fontFamily:e.font}})}}),[n]);return null==r?Object(f.jsx)(f.Fragment,{children:e.children}):Object(f.jsx)(s.a,{theme:r,children:e.children})},b=n(152),O=n(9),j=n(117),m=n(77),p=n(153),g=n(71),S=n(6),h=n(20),E=function(e){Object(r.useEffect)((function(){h.Streamlit.setFrameHeight()}));var t=e.stream.getVideoTracks().length>0,n=Object(r.useCallback)((function(t){t&&(t.srcObject=e.stream)}),[e.stream]),i=Object(r.useCallback)((function(){return h.Streamlit.setFrameHeight()}),[]);if(t){var a,o,c,d,s,l,u,v,b,O,j,m,p,g,E,y,A={hidden:null===(a=e.userDefinedVideoAttrs)||void 0===a?void 0:a.hidden,style:null===(o=e.userDefinedVideoAttrs)||void 0===o?void 0:o.style,autoPlay:null===(c=e.userDefinedVideoAttrs)||void 0===c?void 0:c.autoPlay,controls:null===(d=e.userDefinedVideoAttrs)||void 0===d?void 0:d.controls,controlsList:null===(s=e.userDefinedVideoAttrs)||void 0===s?void 0:s.controlsList,crossOrigin:null===(l=e.userDefinedVideoAttrs)||void 0===l?void 0:l.crossOrigin,loop:null===(u=e.userDefinedVideoAttrs)||void 0===u?void 0:u.loop,mediaGroup:null===(v=e.userDefinedVideoAttrs)||void 0===v?void 0:v.mediaGroup,muted:null===(b=e.userDefinedVideoAttrs)||void 0===b?void 0:b.muted,playsInline:null===(O=e.userDefinedVideoAttrs)||void 0===O?void 0:O.playsInline,preload:null===(j=e.userDefinedVideoAttrs)||void 0===j?void 0:j.preload,height:null===(m=e.userDefinedVideoAttrs)||void 0===m?void 0:m.height,poster:null===(p=e.userDefinedVideoAttrs)||void 0===p?void 0:p.poster,width:null===(g=e.userDefinedVideoAttrs)||void 0===g?void 0:g.width,disablePictureInPicture:null===(E=e.userDefinedVideoAttrs)||void 0===E?void 0:E.disablePictureInPicture,disableRemotePlayback:null===(y=e.userDefinedVideoAttrs)||void 0===y?void 0:y.disableRemotePlayback};return Object(f.jsx)("video",Object(S.a)(Object(S.a)({},A),{},{ref:n,onCanPlay:i}))}var R,I,x,C,N,D,w,P,T,L,k,G={hidden:null===(R=e.userDefinedAudioAttrs)||void 0===R?void 0:R.hidden,style:null===(I=e.userDefinedAudioAttrs)||void 0===I?void 0:I.style,autoPlay:null===(x=e.userDefinedAudioAttrs)||void 0===x?void 0:x.autoPlay,controls:null===(C=e.userDefinedAudioAttrs)||void 0===C?void 0:C.controls,controlsList:null===(N=e.userDefinedAudioAttrs)||void 0===N?void 0:N.controlsList,crossOrigin:null===(D=e.userDefinedAudioAttrs)||void 0===D?void 0:D.crossOrigin,loop:null===(w=e.userDefinedAudioAttrs)||void 0===w?void 0:w.loop,mediaGroup:null===(P=e.userDefinedAudioAttrs)||void 0===P?void 0:P.mediaGroup,muted:null===(T=e.userDefinedAudioAttrs)||void 0===T?void 0:T.muted,playsInline:null===(L=e.userDefinedAudioAttrs)||void 0===L?void 0:L.playsInline,preload:null===(k=e.userDefinedAudioAttrs)||void 0===k?void 0:k.preload};return Object(f.jsx)("audio",Object(S.a)({ref:n},G))},y=i.a.memo(E),A=n(112),R=n(114),I=n(151),x=n(73),C=n.n(x),N=Object(A.a)((function(e){return{paper:{padding:e.spacing(4),display:"flex",justifyContent:"center",alignItems:"center",width:"100%"}}})),D=function(e){Object(r.useEffect)((function(){h.Streamlit.setFrameHeight()}));var t=N();return Object(f.jsx)(R.a,{className:t.paper,elevation:0,children:e.loading?Object(f.jsx)(I.a,{}):Object(f.jsx)(C.a,{fontSize:"large"})})},w=i.a.memo(D),P=n(1),T=n.n(P),L=n(12),k=n(4);function G(e,t,n){var r=e||{};return t&&(!0===r.video?r.video={deviceId:t}:"object"!==typeof r.video&&null!=r.video||(r.video=Object(S.a)(Object(S.a)({},r.video),{},{deviceId:t}))),n&&(!0===r.audio?r.audio={deviceId:n}:"object"!==typeof r.audio&&null!=r.audio||(r.audio=Object(S.a)(Object(S.a)({},r.audio),{},{deviceId:n}))),r}var V={webRtcState:"STOPPED",sdpOffer:null,signallingTimedOut:!1,stream:null,error:null},_=function(e){return function(t,n){var r=function(e,t){switch(t.type){case"SIGNALLING_START":return Object(S.a)(Object(S.a)({},e),{},{webRtcState:"SIGNALLING",stream:null,error:null,signallingTimedOut:!1});case"SIGNALLING_TIMEOUT":return Object(S.a)(Object(S.a)({},e),{},{signallingTimedOut:!0});case"SET_STREAM":return Object(S.a)(Object(S.a)({},e),{},{stream:t.stream});case"SET_OFFER":return Object(S.a)(Object(S.a)({},e),{},{sdpOffer:t.offer});case"STOPPING":return Object(S.a)(Object(S.a)({},e),{},{webRtcState:"STOPPING",sdpOffer:null});case"STOPPED":return Object(S.a)(Object(S.a)({},e),{},{webRtcState:"STOPPED",sdpOffer:null,stream:null});case"START_PLAYING":return Object(S.a)(Object(S.a)({},e),{},{webRtcState:"PLAYING",sdpOffer:null});case"PROCESS_ANSWER_ERROR":return Object(S.a)(Object(S.a)({},e),{},{error:t.error});case"ERROR":return Object(S.a)(Object(S.a)({},e),{},{webRtcState:"STOPPED",sdpOffer:null,error:t.error})}}(t,n),i="PLAYING"===r.webRtcState,a=i!==("PLAYING"===t.webRtcState),o=r.sdpOffer,c=t.sdpOffer;return(a||o!==c)&&(c&&console.log("Send SDP offer",c),e({playing:i,sdpOffer:o?o.toJSON():""})),r}},Y=function(e){return"RECVONLY"===e||"SENDONLY"===e||"SENDRECV"===e},M=function(e){return e.createOffer().then((function(t){return console.log("Created offer:",t),e.setLocalDescription(t)})).then((function(){return console.log("Wait for ICE gethering..."),new Promise((function(t){if("complete"===e.iceGatheringState)t();else{e.addEventListener("icegatheringstatechange",(function n(){"complete"===e.iceGatheringState&&(e.removeEventListener("icegatheringstatechange",n),t())}))}}))})).then((function(){return e.localDescription})).catch((function(e){throw console.error(e),e}))};function F(e){return h.Streamlit.setComponentValue(e)}n(109);var H=function(e){var t,n=Object(r.useState)({video:null,audio:null}),i=Object(O.a)(n,2),a=i[0],o=i[1],c=function(e,t,n,i){Object(r.useEffect)((function(){return i({playing:!1,sdpOffer:""})}),[]);var a=Object(r.useRef)(),o=Object(r.useRef)(),c=Object(r.useMemo)((function(){return _(i)}),[i]),d=Object(r.useReducer)(c,V),s=Object(O.a)(d,2),l=s[0],u=s[1],f=Object(r.useCallback)((function(){"STOPPED"===l.webRtcState&&function(){var r=Object(k.a)(T.a.mark((function r(){var i,c,d,s,l,f,v;return T.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(u({type:"SIGNALLING_START"}),a.current=setTimeout((function(){u({type:"SIGNALLING_TIMEOUT"})}),1e4),i=e.mode,c=e.rtcConfiguration||{},console.log("RTCConfiguration:",c),d=new RTCPeerConnection(c),"SENDRECV"!==i&&"RECVONLY"!==i||d.addEventListener("track",(function(e){var t=e.streams[0];u({type:"SET_STREAM",stream:t})})),"SENDRECV"!==i&&"SENDONLY"!==i){r.next=22;break}if(s=G(e.mediaStreamConstraints,null===t||void 0===t?void 0:t.deviceId,null===n||void 0===n?void 0:n.deviceId),console.log("MediaStreamConstraints:",s),!s.audio&&!s.video){r.next=19;break}if(null!=navigator.mediaDevices){r.next=13;break}throw new Error("navigator.mediaDevices is undefined. It seems the current document is not loaded securely.");case 13:if(null!=navigator.mediaDevices.getUserMedia){r.next=15;break}throw new Error("getUserMedia is not implemented in this browser");case 15:return r.next=17,navigator.mediaDevices.getUserMedia(s);case 17:(l=r.sent).getTracks().forEach((function(e){d.addTrack(e,l)}));case 19:if("SENDONLY"===i){f=Object(L.a)(d.getTransceivers());try{for(f.s();!(v=f.n()).done;)v.value.direction="sendonly"}catch(b){f.e(b)}finally{f.f()}}r.next=23;break;case 22:"RECVONLY"===i&&(d.addTransceiver("video",{direction:"recvonly"}),d.addTransceiver("audio",{direction:"recvonly"}));case 23:return console.log("transceivers",d.getTransceivers()),o.current=d,r.next=27,M(d).then((function(e){if(null==e)throw new Error("Failed to create an offer SDP");u({type:"SET_OFFER",offer:e})}));case 27:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}()().catch((function(e){return u({type:"ERROR",error:e})}))}),[null===n||void 0===n?void 0:n.deviceId,e.mediaStreamConstraints,e.mode,e.rtcConfiguration,l.webRtcState,null===t||void 0===t?void 0:t.deviceId]),v=Object(r.useCallback)((function(){(function(){var e=Object(k.a)(T.a.mark((function e(){var t;return T.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("STOPPING"!==l.webRtcState){e.next=2;break}return e.abrupt("return");case 2:if(t=o.current,o.current=void 0,u({type:"STOPPING"}),null!=t){e.next=7;break}return e.abrupt("return");case 7:return t.getTransceivers&&t.getTransceivers().forEach((function(e){e.stop&&e.stop()})),t.getSenders().forEach((function(e){var t;null===(t=e.track)||void 0===t||t.stop()})),e.abrupt("return",new Promise((function(e){setTimeout((function(){t.close(),e()}),500)})));case 10:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}})()().catch((function(e){return u({type:"ERROR",error:e})})).finally((function(){u({type:"STOPPED"})}))}),[l.webRtcState]);return Object(r.useEffect)((function(){var t=o.current;if(null!=t){var n=e.sdpAnswerJson;if(null==t.remoteDescription&&n&&"SIGNALLING"===l.webRtcState){var r=JSON.parse(n);console.log("Receive answer sdpOffer",r),t.setRemoteDescription(r).then((function(){console.log("Remote description is set"),a.current&&clearTimeout(a.current),u({type:"START_PLAYING"})})).catch((function(e){u({type:"PROCESS_ANSWER_ERROR",error:e}),v()}))}}}),[e.sdpAnswerJson,l.webRtcState,v]),Object(r.useEffect)((function(){var t=e.desiredPlayingState;null!=t&&(!0===t&&"STOPPED"===l.webRtcState?f():!1!==t||"SIGNALLING"!==l.webRtcState&&"PLAYING"!==l.webRtcState||v())}),[e.desiredPlayingState,f,l.webRtcState,v]),{start:f,stop:v,state:l}}(e,a.video,a.audio,e.onComponentValueChange),d=c.state,s=c.start,l=c.stop,u=e.mode,v=e.disabled||"SIGNALLING"===d.webRtcState&&!d.signallingTimedOut||"STOPPING"===d.webRtcState||null!=e.desiredPlayingState,b=Y(u)&&function(e){return"SENDRECV"===e||"RECVONLY"===e}(u),S=Y(u)&&function(e){return"SENDRECV"===e||"SENDONLY"===e}(u),h={videoEnabled:!(t=e.mediaStreamConstraints)||!!t.video,audioEnabled:!t||!!t.audio},E=h.videoEnabled,A=h.audioEnabled,R=Object(r.useCallback)((function(e,t){o({video:e,audio:t})}),[]);return Object(f.jsxs)(j.a,{children:[d.error&&Object(f.jsxs)(p.a,{severity:"error",children:[d.error.name,": ",d.error.message]}),Object(f.jsx)(j.a,{py:1,display:"flex",children:d.stream?Object(f.jsx)(y,{stream:d.stream,userDefinedVideoAttrs:e.videoHtmlAttrs,userDefinedAudioAttrs:e.audioHtmlAttrs}):b&&Object(f.jsx)(w,{loading:"SIGNALLING"===d.webRtcState})}),Object(f.jsxs)(j.a,{display:"flex",justifyContent:"space-between",children:["PLAYING"===d.webRtcState||"SIGNALLING"===d.webRtcState?Object(f.jsx)(m.a,{variant:"contained",onClick:l,disabled:v,children:"Stop"}):Object(f.jsx)(m.a,{variant:"contained",color:"primary",onClick:s,disabled:v,children:"Start"}),S&&Object(f.jsx)(g.a,{videoEnabled:E,audioEnabled:A,onSelect:R,value:a})]})]})},J=function(){var e=Object(c.useRenderData)(),t=e.args.mode,n=e.args.desired_playing_state,r=e.args.sdp_answer_json,i=e.args.rtc_configuration,a=e.args.media_stream_constraints,o=e.args.video_html_attrs,d=e.args.audio_html_attrs;if(!Y(t))throw new Error("Invalid mode ".concat(t));return Object(f.jsx)(H,{disabled:e.disabled,mode:t,desiredPlayingState:n,sdpAnswerJson:r,rtcConfiguration:i,mediaStreamConstraints:a,videoHtmlAttrs:o,audioHtmlAttrs:d,onComponentValueChange:F})};o.a.render(Object(f.jsx)(i.a.StrictMode,{children:Object(f.jsx)(c.StreamlitProvider,{children:Object(f.jsxs)(v,{children:[Object(f.jsx)(b.a,{}),Object(f.jsx)(J,{})]})})}),document.getElementById("root"))},71:function(e,t,n){"use strict";(function(e){var r=n(12),i=n(9),a=n(0),o=n.n(a),c=n(20),d=n(117),s=n(112),l=n(77),u=n(65),f=n(79),v=n(78),b=n(119),O=n(115),j=n(114),m=n(7),p=Object(s.a)((function(e){return{paper:{padding:e.spacing(2)},formControl:{maxWidth:"80vw",margin:e.spacing(1),minWidth:120,display:"flex"},formButtonControl:{margin:e.spacing(2),marginBottom:e.spacing(1),minWidth:120,display:"flex"},selectEmpty:{marginTop:e.spacing(2)}}})),g=function(t){var n=t.labelId,r=t.value,i=t.devices,o=t.onChange,c=p(),d=Object(a.useCallback)((function(e){var t=i.find((function(t){return t.deviceId===e.target.value}));o(t||null)}),[i,o]);return 0===i.length?Object(m.jsx)(v.a,{value:"",disabled:!0,children:Object(m.jsx)("option",{"aria-label":"None",value:""})}):null==r?(e((function(){return o(i[0])})),null):Object(m.jsx)(v.a,{labelId:n,value:r.deviceId,onChange:d,className:c.selectEmpty,children:i.map((function(e){return Object(m.jsx)(b.a,{value:e.deviceId,children:e.label},e.deviceId)}))})},S=function(e){var t=e.open,n=e.anchorEl,r=e.videoEnabled,o=e.audioEnabled,d=e.value,s=e.devicesMap,v=e.onSubmit,b=Object(a.useState)(null),S=Object(i.a)(b,2),h=S[0],E=S[1],y=Object(a.useState)(null),A=Object(i.a)(y,2),R=A[0],I=A[1];Object(a.useEffect)((function(){E(s.video.find((function(e){var t;return e.deviceId===(null===(t=d.video)||void 0===t?void 0:t.deviceId)}))||null),I(s.audio.find((function(e){var t;return e.deviceId===(null===(t=d.audio)||void 0===t?void 0:t.deviceId)}))||null)}),[s,d]);var x=Object(a.useCallback)((function(e){e.preventDefault(),v(r?h:null,o?R:null)}),[v,r,o,h,R]),C=p(),N=Object(a.useRef)(),D=Object(a.useCallback)((function(e){if(e)setTimeout((function(){var t=document.getElementsByTagName("body")[0];N.current=t.style.height;var n=window.getComputedStyle(e),r=new WebKitCSSMatrix(n.transform).m42+e.getBoundingClientRect().height;r>document.body.scrollHeight&&(t.style.height="".concat(r,"px"),c.Streamlit.setFrameHeight())}),0);else{var t=document.getElementsByTagName("body")[0];null!=N.current&&(t.style.height=N.current),c.Streamlit.setFrameHeight()}}),[]);return Object(m.jsx)(O.a,{ref:D,open:t,anchorEl:n,placement:"left-end",children:Object(m.jsx)(j.a,{className:C.paper,children:Object(m.jsxs)("form",{onSubmit:x,children:[r&&Object(m.jsxs)(u.a,{className:C.formControl,children:[Object(m.jsx)(f.a,{id:"video-input-select",children:"Video input"}),Object(m.jsx)(g,{labelId:"video-input-select",devices:s.video,value:h,onChange:E})]}),o&&Object(m.jsxs)(u.a,{className:C.formControl,children:[Object(m.jsx)(f.a,{id:"audio-input-select",children:"Audio input"}),Object(m.jsx)(g,{labelId:"audio-input-select",devices:s.audio,value:R,onChange:I})]}),Object(m.jsx)(u.a,{className:C.formButtonControl,children:Object(m.jsx)(l.a,{type:"submit",variant:"contained",color:"primary",children:"OK"})})]})})})},h=function(e){var t=e.videoEnabled,n=e.audioEnabled,c=e.value,s=e.onSelect,u=Object(a.useState)(!1),f=Object(i.a)(u,2),v=f[0],b=f[1],O=o.a.useState(null),j=Object(i.a)(O,2),p=j[0],g=j[1],h=Object(a.useState)(),E=Object(i.a)(h,2),y=E[0],A=E[1],R=Object(a.useState)(!1),I=Object(i.a)(R,2),x=I[0],C=I[1],N=Object(a.useCallback)((function(e){var t,n;if(g(e.currentTarget),"function"!==typeof(null===(t=navigator)||void 0===t||null===(n=t.mediaDevices)||void 0===n?void 0:n.enumerateDevices))return A(void 0),void C(!0);navigator.mediaDevices.enumerateDevices().then((function(e){var t,n=[],i=[],a=Object(r.a)(e);try{for(a.s();!(t=a.n()).done;){var o=t.value;"videoinput"===o.kind?n.push(o):"audioinput"===o.kind&&i.push(o)}}catch(c){a.e(c)}finally{a.f()}A({video:n,audio:i}),b(!0)}))}),[]),D=Object(a.useCallback)((function(){return b(!1)}),[]),w=Object(a.useCallback)((function(e,t){A(void 0),b(!1),s(e,t)}),[s]);return Object(m.jsxs)(d.a,{children:[x&&Object(m.jsx)("p",{children:"Unavailable"}),y&&Object(m.jsx)(S,{open:v,anchorEl:p,videoEnabled:t,audioEnabled:n,value:c,devicesMap:y,onSubmit:w}),Object(m.jsx)(l.a,{onClick:v?D:N,children:"Select device"})]})};t.a=o.a.memo(h)}).call(this,n(101).setImmediate)}},[[110,1,2]]]);
//# sourceMappingURL=main.39e42bc1.chunk.js.map